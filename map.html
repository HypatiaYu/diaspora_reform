<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Map</title>
    <style>
        body { margin: 0; overflow: hidden; font-family: Arial, sans-serif; }
        #controls {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 100;
            display: flex;
            gap: 10px;
        }
        button {
            padding: 12px 24px;
            font-size: 16px;
            cursor: pointer;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
        }
        button:hover { background: #45a049; }
        button.secondary { background: #2196F3; }
        button.secondary:hover { background: #1976D2; }
        #info {
            position: absolute;
            top: 20px;
            right: 20px;
            color: white;
            font-size: 14px;
            z-index: 100;
            background: rgba(0,0,0,0.6);
            padding: 15px;
            border-radius: 4px;
            min-width: 200px;
        }
        .instructions {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #555;
            font-size: 12px;
            color: #aaa;
        }
        #resources {
            position: absolute;
            top: 180px;
            right: 20px;
            color: #ffd700;
            font-size: 13px;
            z-index: 100;
            max-height: 60vh;
            overflow-y: auto;
            background: rgba(0,0,0,0.6);
            padding: 10px;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div id="controls">
        <button id="spawnBaseBtn">Spawn Base</button>
        <button id="spawnResourcesBtn" class="secondary">Spawn Random Resources</button>
    </div>
    <div id="info">
        <div id="count">Bases: 0 | Drones: 0</div>
        <div id="collected">Resources Collected: 0</div>
        <div class="instructions">
            <strong>Controls:</strong><br>
            • Click "Spawn Base" to create a base + drones<br>
            • Click on a BASE to spawn 3 drones<br>
            • Click on a DRONE to select it<br>
            • Shift+Click on DRONE to select all drones<br>
            • Click on RESOURCE to assign drones to collect
        </div>
    </div>
    <div id="resources"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x1a1a2e);

        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(0, 20, 30);
        camera.lookAt(0, 0, 0);

        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true;
        document.body.appendChild(renderer.domElement);

        const ambientLight = new THREE.AmbientLight(0x404040, 0.6);
        scene.add(ambientLight);

        const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
        directionalLight.position.set(10, 20, 10);
        directionalLight.castShadow = true;
        scene.add(directionalLight);

        const floorGeometry = new THREE.PlaneGeometry(60, 60);
        const floorMaterial = new THREE.MeshStandardMaterial({ 
            color: 0x2d3436,
            side: THREE.DoubleSide 
        });
        const floor = new THREE.Mesh(floorGeometry, floorMaterial);
        floor.rotation.x = -Math.PI / 2;
        floor.receiveShadow = true;
        scene.add(floor);

        const gridHelper = new THREE.GridHelper(60, 60, 0x444444, 0x333333);
        scene.add(gridHelper);

        let isDragging = false;
        let previousMousePosition = { x: 0, y: 0 };
        let cameraAngle = 0;
        let cameraHeight = 20;
        let cameraRadius = 30;

        renderer.domElement.addEventListener('mousedown', (e) => {
            isDragging = true;
            previousMousePosition = { x: e.clientX, y: e.clientY };
        });

        renderer.domElement.addEventListener('mousemove', (e) => {
            if (!isDragging) return;
            
            const deltaX = e.clientX - previousMousePosition.x;
            const deltaY = e.clientY - previousMousePosition.y;
            
            cameraAngle += deltaX * 0.01;
            cameraHeight = Math.max(5, Math.min(50, cameraHeight - deltaY * 0.1));
            
            previousMousePosition = { x: e.clientX, y: e.clientY };
        });

        renderer.domElement.addEventListener('mouseup', () => isDragging = false);
        renderer.domElement.addEventListener('mouseleave', () => isDragging = false);

        renderer.domElement.addEventListener('wheel', (e) => {
            cameraRadius = Math.max(10, Math.min(60, cameraRadius + e.deltaY * 0.05));
        });

        function updateCamera() {
            camera.position.x = Math.sin(cameraAngle) * cameraRadius;
            camera.position.z = Math.cos(cameraAngle) * cameraRadius;
            camera.position.y = cameraHeight;
            camera.lookAt(0, 0, 0);
        }

        let totalResourcesCollected = 0;

        function updateInfo() {
            document.getElementById('count').textContent = 
                `Bases: ${BaseEntity.instances.length} | Drones: ${DroneEntity.instances.length}`;
            document.getElementById('collected').textContent = 
                `Resources Collected: ${totalResourcesCollected}`;
        }

        function animate() {
            requestAnimationFrame(animate);
            updateCamera();
            updateDrones();
            renderer.render(scene, camera);
        }

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        animate();
    </script>

    <script src="spawn.js"></script>
    <script src="resources.js"></script>
    <script>
        function findValidPosition(minDist = 5) {
            let attempts = 0;
            let position;
            let valid = false;
            
            while (!valid && attempts < 50) {
                const x = (Math.random() - 0.5) * 30;
                const z = (Math.random() - 0.5) * 30;
                position = new THREE.Vector3(x, 0, z);
                
                valid = true;
                for (const base of BaseEntity.instances) {
                    if (base.mesh.position.distanceTo(position) < minDist) {
                        valid = false;
                        break;
                    }
                }
                attempts++;
            }
            return position;
        }

        document.getElementById('spawnBaseBtn').addEventListener('click', () => {
            const position = findValidPosition(6);
            const base = new BaseEntity(scene, position);
            updateInfo();
        });
        
        document.getElementById('spawnResourcesBtn').addEventListener('click', () => {
            spawnRandomResources();
            updateResourceUI();
        });

        let selectedDrone = null;
        let selectedDrones = [];
        let shiftPressed = false;

        document.addEventListener('keydown', (e) => {
            if (e.shiftKey) {
                shiftPressed = true;
            }
        });

        document.addEventListener('keyup', (e) => {
            if (!e.shiftKey) {
                shiftPressed = false;
            }
        });

        function selectDrone(drone) {
            if (shiftPressed) {
                DroneEntity.instances.forEach(d => {
                    d.setSelected(true);
                });
                selectedDrones = [...DroneEntity.instances];
                return;
            }
            
            if (selectedDrone && selectedDrone.mesh) {
                selectedDrone.setSelected(false);
            }
            selectedDrones = [];
            selectedDrone = drone;
            if (selectedDrone) {
                selectedDrone.setSelected(true);
            }
        }

        function clearSelection() {
            if (selectedDrone) {
                selectedDrone.setSelected(false);
                selectedDrone = null;
            }
            selectedDrones.forEach(d => d.setSelected(false));
            selectedDrones = [];
        }

        const raycaster = new THREE.Raycaster();
        const mouse = new THREE.Vector2();

        renderer.domElement.addEventListener('click', (event) => {
            mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;
            
            raycaster.setFromCamera(mouse, camera);
            
            const baseObjects = BaseEntity.instances.map(b => b.mesh);
            const droneObjects = DroneEntity.instances.map(d => d.mesh);
            const resourceObjects = ResourceNode.instances.map(r => r.mesh);
            
            const baseIntersects = raycaster.intersectObjects(baseObjects);
            if (baseIntersects.length > 0) {
                let clickedBase = baseIntersects[0].object.userData.base;
                if (!clickedBase) {
                    for (let obj = baseIntersects[0].object; obj; obj = obj.parent) {
                        if (obj.userData && obj.userData.base) {
                            clickedBase = obj.userData.base;
                            break;
                        }
                    }
                }
                if (clickedBase) {
                    clickedBase.spawnDrones(3);
                    updateInfo();
                    return;
                }
            }
            
            const droneIntersects = raycaster.intersectObjects(droneObjects, true);
            if (droneIntersects.length > 0) {
                let clickedDrone = droneIntersects[0].object.userData.drone;
                if (!clickedDrone) {
                    for (let obj = droneIntersects[0].object; obj; obj = obj.parent) {
                        if (obj.userData && obj.userData.drone) {
                            clickedDrone = obj.userData.drone;
                            break;
                        }
                    }
                }
                if (clickedDrone) {
                    selectDrone(clickedDrone);
                    return;
                }
            }
            
            const dronesToAssign = selectedDrone ? [selectedDrone] : selectedDrones;
            
            if (dronesToAssign.length > 0) {
                const resourceIntersects = raycaster.intersectObjects(resourceObjects, true);
                if (resourceIntersects.length > 0) {
                    let clickedResource = resourceIntersects[0].object.userData.resource;
                    if (!clickedResource) {
                        for (let obj = resourceIntersects[0].object; obj; obj = obj.parent) {
                            if (obj.userData && obj.userData.resource) {
                                clickedResource = obj.userData.resource;
                                break;
                            }
                        }
                    }
                    if (clickedResource) {
                        dronesToAssign.forEach(d => d.assignToResource(clickedResource));
                        clearSelection();
                        return;
                    }
                }
            }
            
            clearSelection();
        });

        spawnRandomResources();
    </script>
</body>
</html>
